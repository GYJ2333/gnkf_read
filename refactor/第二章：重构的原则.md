# 第二章 重构的原则

## 什么是重构

重构，名词是指各种重构手法；动词是指运用这些重构手法来调整代码结构。

重构的关键之处在于运用大量微小且保持软件行为的步骤，一步步达成大规模的修改。在重构的过程中，代码应该很少进入不可工作的状态。重构后和重构前代码的行为不应发生变化。

在使用重构技术开发软件时，无论何时都要清楚自己是在添加新功能还是重构，并且要明白这两种工作对编程状态的不同要求。添加新功能时就不应该修改既有代码，只管添加新功能，然后添加测试并让测试通过。重构时就不要添加新功能，只管调整代码的结构，此时也不应该添加任何测试（除非之前有遗漏）。



## 为何要重构

**1.改进软件的设计**

如果没有重构，程序的内部设计（或者叫架构） 会逐渐腐败变质。因为人们经常会在没有完全理解架构的整体设计上去修改代码，这样就导致代码越来越难懂。经常性的重构有助于维持代码该有的形态。

**2.使软件更容易理解**

**3.帮助找到bug**

当对代码使用重构搞清楚程序结构后，也就不难找出其中的bug了。

**4.提高编码速度**

直观上讲，花在重构上的时间是在降低开发的速度。但若是没有重构，一个项目开发到后期，可能需要花费更多的时间考虑如何添加新功能，如何修复不断蹦出来的bug，代码也越来越难理解。而重构可以很好的改善这些情况。因此，可以说重构时提高了编码速度。



## 何时要重构

有计划的重构应该少部分的，大部分重构应该是不起眼的、见机行事的。  

**1.在添加新功能之前**

`优秀的程序员知道，添加新功能最快的方法往往是先修改现有的代码，使新功能容易被加入。`

**2.修复bug的时候**

在修复bug的时候发现一些问题如果及时的进行重构，那么可能会有效降低之后bug出现的概率。

**3.想要代码变得更容易理解**

**4.长期的重构**

例如要替换一个正在使用的库，或者将整块代码抽取到一个组件中并共享给另一支团队使用，再或者要处理一大堆混乱的依赖关系，等等。  

**5.code review时重构**

## 何时不需要重构

如果我看见一块凌乱的代码，但并不需要修改它，那么我就不需要重构它。 另一种情况是，如果重写比重构还容易，就别重构了。但如果不花一点儿时间尝试，往往很难真实了解重构一块代码的难度。



## 重构的挑战

**1.延缓新功能的开发**

尽管重构的目的是加快开发速度，但仍旧很多人认为，花在重构的时间是在拖慢新功能的开发进度。 其实，`重构的唯一目的就是让我们开发更快， 用更少的工作量创造更大的价值。`

有一种情况确实需要权衡取舍。我有时会看到一个（大规模的）重构很有必要进行，而马上要添加的功能非常小，这时我会更愿意先把新功能加上，然后再做这次大规模重构。

重构的意义不在于把代码库打磨得闪闪发光，而是纯粹经济角度出发的考量。我们之所以重构，因为它能让我们更快——添加功能更快，修复bug更快。

**2.代码的所有权**

很多重构手法不仅会影响一个模块内部， 还会影响该模块与系统其他部分的关系。如果这写代码不是归一个团队所拥有，那么想要重构就需要更大的成本了。因此作者建议，不要搞细粒度的代码所有制。

**3.分支**

很多团队采用这样的版本控制实践：每个团队成员各自在代码库的一条分支上工作，进行相当大量的开发之后，才把各自的修改合并回主线分支。这种做法好处是能保持主线不受尚未完成的代码侵扰，能保留清晰的功能添加的版本记录，并且在某个功能出问题时能容易地撤销修改。但缺点是在隔离的分支上工作得越久，将完成的工作集成回主线就会越困难。

作者认为特性分支的生命还应该更短，其采用的方法叫作持续集成（Continuous Integration， CI）。在使用CI时，每个团队成员每天至少向主线集成一次。这个实践避免了任何分支彼此差异太大，从而极大地降低了合并的难度。不过CI也有其代价：必须使用相关的实践以确保主线随时处于健康状态，必须学会将大功能拆分成小块，还必须使用特性开关（feature toggle，也叫特性旗标， feature flag）将尚未完成又无法拆小的功能隐藏掉。

**4.测试**

如果想要做到在重构中快速发现错误，那么代码应该有一套完备的测试套件，并且运行速度要快，否则我会不愿意频繁运行它。也就是说，绝大多数情况下，如果想要重构，我得先有可以自测试的代码。因此团队必须投入时间和精力在测试上。

**5.遗留代码**

遗留系统多半没测试。如果你面对一个庞大而又缺乏测试的遗留系统，很难安全地重构清理它。因为给遗留代码添加测试是困难的。

就算有了测试，作者也不建议你尝试一鼓作气把复杂而混乱的遗留代码重构成漂亮的代码。我更愿意随时重构相关的代码：每次触碰一块代码时，我会尝试把它变好一点点。

## 重构、架构和YAGNI

很多人会认为：在任何人开始写代码之前，必须先完成软件的设计和架构。一旦代码写出来，架构就固定了，只会因为程序员的草率对待而逐渐腐败。但有了重构技术，即便是已经在生产环境中运行了多年的软件，我们也有能力大幅度修改其架构。“在编码之前先完成架构”这种做法最大的问题在于，它假设了软件的需求可以预先充分理解。但经验显示，这个假设很多时候甚至可以说大多数时候是不切实际的。只有真正使用了软件、看到了软件对工作的影响，人们才会想明白自己到底需要什么，这样的例子不胜枚举。

重构对架构最大的影响在于，通过重构，我们能得到一个设计良好的代码库，使其能够优雅地应对不断变化的需求。



## 重构与性能

除了对性能有严格要求的实时系统，其他任何情况下“编写快速软件”的秘密就是：先写出可调优的软件，然后调优它以求获得足够的速度。



## 自动化重构

自动化重构通常是借助于IDE中的重构工具来完成。在JetBrains的IntelliJ IDEA集成开发环境（IDE）中，自动化重构是最亮眼的特性之一。

